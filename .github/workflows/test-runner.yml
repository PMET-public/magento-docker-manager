name: test runner

on:
  push:

env:
  # set a default terminal for various cmds that expect it
  TERM: xterm
  COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
  SLACK_WEBHOOK_URL_FOR_TMATE_FROM_GITHUB_WORKFLOW: ${{ secrets.SLACK_WEBHOOK_URL_FOR_TMATE_FROM_GITHUB_WORKFLOW }}
  TMATE_AUTHORIZED_KEYS_URL: ${{ secrets.TMATE_AUTHORIZED_KEYS_URL }}

jobs:
  run-CI-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
        # value: [true, ""]
        value: [true]
    env:
      debug: ${{ matrix.value }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: 'true'
      - name: 1 checkout
        run: |
          ./tests/bats/01-checkout.bats
      - name: 1a mac required
          run: |
            ./tests/bats/01a-mac-required.bats
      - name: 1b docker required
          run: |
            ./tests/bats/01b-docker-required.bats
      - name: 2 install
        run: |
          ./tests/bats/02-install.bats
      - name: 2a certs tests
        run: |
          ./tests/bats/02a-certs.bat
      - name: non-docker tests
        run: |
          ./tests/CI/non-docker-menu-selections.sh
      - name: docker tests
        run: |
          ./tests/CI/docker-menu-selections.sh
      - name: create detached mdm
        run: |
          ./tests/CI/create-detached-mdm.sh
      - name: create mdm app from mc repo
        run: |
          ./tests/CI/create-mdm-app-from-mc-repo.sh
      - name: check homebrew dependency behavior
        run: |
          ./tests/CI/check-homebrew.sh
      - name: keepalive to debug
        if: ${{ failure() }}
        uses: PMET-public/action-tmate@master
