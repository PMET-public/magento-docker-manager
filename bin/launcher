#!/usr/bin/env bash

set -e # stop on errors
[[ $debug ]] && set -x

# understanding the Platypus UX:
#
# when clicked in the status bar, a Platypus status menu app runs (without arguments) to completion
# and displays each line of STDOUT as an option, so it's critical to complete ASAP to reduce perceived latency
#
# then when a menu item is selected, this script runs again in the background w/ the menu item text passed as an arg
# this time Platyplus app will not wait for the background run to complete before the menu can be rendered again
#
# understanding this script:
#
# check dependencies and if passing, source the main mdm functionality
# otherwise offer a single option to install dependencies when selected
#
# the depedency check should run every time in case its copied to new computer

if [[

  ${BASH_VERSINFO[0]} -ge 4 && \
  -n "$(which realpath)" && \
  -f "$HOME/.mdm/current/bin/mdm" && \
  ( "$(uname)" != "Darwin" || -n "$(which brew)" ) && \
  ( -n "$(which docker)" || ( "$(uname)" = "Darwin" && $TRAVIS ) )

]]; then

  # allow mdm_script_path to be set by the env for debugging
  mdm_script_path="${TRAVIS_BUILD_DIR:-$HOME/.mdm/current}/bin/mdm"
  # shellcheck source=mdm
  source "$mdm_script_path"

else

  # some dependency is missing and this script was called without args, so prompt user to install

  if [[ ${#BASH_ARGV[@]} -eq 0 ]]; then

    echo "Install missing requirements on this computer" && exit

  else

    installer=$(mktemp)
    curl -sL https://raw.githubusercontent.com/PMET-public/mdm/${TRAVIS_BRANCH:-master}/bin/install.sh > "$installer"
    chmod +x "$installer"
    if [[ "$(uname)" = "Darwin" && -z $TRAVIS ]]; then
      open -a Terminal "$installer"
    else
      "$installer"
    fi

  fi

fi


