#!/usr/bin/env bash

set -e # stop on errors
[[ $debug ]] && set -x

# understanding the Platypus UX:
#
# when clicked in the status bar, a Platypus status menu app runs (without arguments) to completion
# and displays each line of STDOUT as an option, so it's critical to complete ASAP to reduce perceived latency
#
# then when a menu item is selected, this script runs again in the background w/ the menu item text passed as an arg
# this time Platyplus app will not wait for the background run to complete before the menu can be rendered again
#
# understanding this script:
#
# check dependencies and if passing, source the main mdm functionality
# otherwise offer a single option to install dependencies when selected
#
# the depedency check should run every time in case its copied to new computer

is_mac() {
  [[ "$(uname)" = "Darwin" ]]
}

is_CI() {
  [[ $GITHUB_REF || $TRAVIS ]]
}

# allow mdm_script_path to be set by env var for debugging or testing
if [[ $GITHUB_REF ]]; then
  REPO_DIR="$GITHUB_WORKSPACE"
  REPO_BRANCH=" ${GITHUB#refs/heads/}"
elif [[ $TRAVIS ]]; then
  REPO_DIR="$TRAVIS_BUILD_DIR"
  REPO_BRANCH="$TRAVIS_BRANCH"
fi

if [[

  ${BASH_VERSINFO[0]} -ge 4 && \
  -n "$(which realpath)" && \
  -f "$HOME/.mdm/current/bin/mdm" && \
  ( "$(uname)" != "Darwin" || -n "$(which brew)" ) && \
  ( -n "$(which docker)" || ( $(is_mac) && ! $(is_CI) ) )

]]; then

  mdm_script_path="${REPO_DIR:-$HOME/.mdm/current}/bin/mdm"
  # shellcheck source=mdm
  source "$mdm_script_path"

else

  # some dependency is missing and this script was called without args, so prompt user to install

  if [[ ${#BASH_ARGV[@]} -eq 0 ]]; then

    echo "Install missing requirements on this computer" && exit

  else

    installer=$(mktemp)
    curl -sL "https://raw.githubusercontent.com/PMET-public/mdm/${REPO_BRANCH:-master}/bin/install.sh" > "$installer"
    chmod +x "$installer"
    if is_mac && ! is_CI; then
      open -a Terminal "$installer"
    else
      "$installer"
    fi

  fi

fi


