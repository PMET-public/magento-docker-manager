#!/usr/bin/env bash

set -e
#set -x

lib_dir="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
name="$(basename ${BASH_SOURCE[0]})"

perl -ne '
  /^[^#]*key=/ and not /\bOFF\b/ and print;
  /^[^#]*$key-link/ and print;
  /^\s*#\s+(start|end)/ and print;
  /^[^#]*description="[^"]/ and print;
' "$lib_dir/menu-items.sh" |
  perl -pe '
    s/.*key="([^"]+)".*/$1/;
    s/.*key-link[^=]+="([^"]+)"/[link]($1)/;
    s/.*(#\s+start.*submenu)/\n$1/i;
    s/.*(#\s+end.*submenu)/$1\n/i;
  ' |
  perl -0777 -pe '
    s/\n\s*(description="[^"]+")/|   |$1/g;    # join description to previous line
    s/\n\[link/ |[link/g;    # join link to previous line
    s/(#\s+start.*\n.+\n)/$1|:---|:-:|:--|\n/g;    # create MD header separator on submenus
    s/\n\n([^#\n].*)/\n\nTop Level Menu Items\n|:---|:-:|:--|\n$1/g;    # create header on top levem menu items
    s/^/\n\nTop Level Menu Items\n|:---|:-:|:--|\n$1/;    # create header on top levem menu items
  ' |
  perl -pe '
    /^[^#|].+$/ and not /description=/ and s/^/|/ and s/$/|   |   |/;    # make each w/o descriptions -> row 3 cols
    /\[link\]/ and s/\|   \|/\|/;    # make 2nd col link for links
    s/^(.*)\|description="(.*?)"(.*)$/|$1$3|$2|/;    # reorder descriptions after links
    s/^(#.*)/<!--- $1 --->/;    # use MD comments to hide submenu delimiters
    s/\bON\b/ON\\|OFF/;    # show both toggle values in the menu item
  ' |
  perl -0777 -pe "
    s/^/<!--- start of menu MD generated by $name --->/;
    s/$/\n<!--- end of menu MD generated by $name --->/;
  "